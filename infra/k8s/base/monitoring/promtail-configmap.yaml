apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  labels:
    app: promtail
    component: monitoring
data:
  promtail.yaml: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki-gateway:3100/loki/api/v1/push

    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_controller_name
            regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
            action: replace
            target_label: __tmp_controller_name
          - source_labels:
              - __meta_kubernetes_pod_label_app
            target_label: app
          - source_labels:
              - __meta_kubernetes_pod_label_component
            target_label: component
          - source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: node_name
          - source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - source_labels:
              - __meta_kubernetes_pod_container_name
            target_label: container
          - source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log
          - source_labels:
              - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash
              - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash
              - __meta_kubernetes_pod_container_name
            regex: true;(.+);(.+)
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/$2/*.log
        pipeline_stages:
          - cri: {}
          - regex:
              expression: '(?P<email>[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})'
          - replace:
              expression: '(?P<email>[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})'
              replace: '[EMAIL_REDACTED]'
          - regex:
              expression: '(?P<ipv4>\b(?:\d{1,3}\.){3}\d{1,3}\b)'
          - replace:
              expression: '(?P<ipv4>\b(?:\d{1,3}\.){3}\d{1,3}\b)'
              replace: '[IP_REDACTED]'
          - regex:
              expression: '(?P<wallet>0x[a-fA-F0-9]{40})'
          - replace:
              expression: '(?P<wallet>0x[a-fA-F0-9]{40})'
              replace: '0x[WALLET_REDACTED]'
          - regex:
              expression: '(?P<api_key>(?:api[_-]?key|apikey|token)["\s:=]+[a-zA-Z0-9_-]{20,})'
          - replace:
              expression: '(?P<api_key>(?:api[_-]?key|apikey|token)["\s:=]+[a-zA-Z0-9_-]{20,})'
              replace: '[API_KEY_REDACTED]'
          - regex:
              expression: '(?P<ssn>\b\d{3}-\d{2}-\d{4}\b)'
          - replace:
              expression: '(?P<ssn>\b\d{3}-\d{2}-\d{4}\b)'
              replace: '[SSN_REDACTED]'
          - regex:
              expression: '(?P<credit_card>\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b)'
          - replace:
              expression: '(?P<credit_card>\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b)'
              replace: '[CARD_REDACTED]'
          - labels:
              namespace:
              pod:
              container:
              app:
              component:
              node_name:

      - job_name: kubernetes-pods-static
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels:
              - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror
            action: drop
            regex: ""
          - source_labels:
              - __meta_kubernetes_pod_label_app
            target_label: app
          - source_labels:
              - __meta_kubernetes_pod_label_component
            target_label: component
          - source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - source_labels:
              - __meta_kubernetes_pod_container_name
            target_label: container
          - replacement: /var/log/pods/*$1/*.log
            separator: /
            source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__
        pipeline_stages:
          - cri: {}
          - regex:
              expression: '(?P<email>[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})'
          - replace:
              expression: '(?P<email>[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})'
              replace: '[EMAIL_REDACTED]'
          - regex:
              expression: '(?P<ipv4>\b(?:\d{1,3}\.){3}\d{1,3}\b)'
          - replace:
              expression: '(?P<ipv4>\b(?:\d{1,3}\.){3}\d{1,3}\b)'
              replace: '[IP_REDACTED]'
          - regex:
              expression: '(?P<wallet>0x[a-fA-F0-9]{40})'
          - replace:
              expression: '(?P<wallet>0x[a-fA-F0-9]{40})'
              replace: '0x[WALLET_REDACTED]'
          - labels:
              namespace:
              pod:
              container:
              app:
              component:
