apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: ghost-protocol-prod

bases:
- ../../base

namePrefix: prod-

commonLabels:
  environment: production

# ConfigMap Generator - Creates ConfigMap from .env file for dynamic value injection
configMapGenerator:
- name: kustomize-values
  envs:
  - .env
  options:
    disableNameSuffixHash: true

# Environment-specific deployment configurations
patches:
# API Gateway Configuration
- target:
    kind: Deployment
    name: api-gateway
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 3
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 250m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 512Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 1Gi

# Indexer Configuration
- target:
    kind: Deployment
    name: indexer
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 3
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 500m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 1Gi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 2000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 2Gi

# RPC Orchestrator Configuration
- target:
    kind: Deployment
    name: rpc-orchestrator
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 3
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 300m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 512Mi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 1000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 1Gi

# AI Engine Configuration
- target:
    kind: Deployment
    name: ai-engine
  patch: |-
    - op: replace
      path: /spec/replicas
      value: 2
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/cpu
      value: 1000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/requests/memory
      value: 4Gi
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/cpu
      value: 4000m
    - op: replace
      path: /spec/template/spec/containers/0/resources/limits/memory
      value: 8Gi

# HPA Configurations
- target:
    kind: HorizontalPodAutoscaler
    name: api-gateway
  patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 3
    - op: replace
      path: /spec/maxReplicas
      value: 10

- target:
    kind: HorizontalPodAutoscaler
    name: indexer
  patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 3
    - op: replace
      path: /spec/maxReplicas
      value: 6

- target:
    kind: HorizontalPodAutoscaler
    name: rpc-orchestrator
  patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 3
    - op: replace
      path: /spec/maxReplicas
      value: 5

- target:
    kind: HorizontalPodAutoscaler
    name: ai-engine
  patch: |-
    - op: replace
      path: /spec/minReplicas
      value: 2
    - op: replace
      path: /spec/maxReplicas
      value: 3

# ExternalSecret secret path patches (production environment)
- target:
    kind: ExternalSecret
    name: database-credentials
  patch: |-
    - op: replace
      path: /spec/dataFrom/0/extract/key
      value: ghost-protocol/production/database/credentials

- target:
    kind: ExternalSecret
    name: redis-credentials
  patch: |-
    - op: replace
      path: /spec/data/0/remoteRef/key
      value: ghost-protocol/production/redis/password

- target:
    kind: ExternalSecret
    name: openai-api-key
  patch: |-
    - op: replace
      path: /spec/data/0/remoteRef/key
      value: ghost-protocol/production/api-keys/openai

- target:
    kind: ExternalSecret
    name: huggingface-api-key
  patch: |-
    - op: replace
      path: /spec/data/0/remoteRef/key
      value: ghost-protocol/production/api-keys/huggingface

# SecretStoreRef namespace patches (production environment)
- target:
    kind: ExternalSecret
    name: database-credentials
  patch: |-
    - op: replace
      path: /spec/secretStoreRef/namespace
      value: ghost-protocol-prod

- target:
    kind: ExternalSecret
    name: redis-credentials
  patch: |-
    - op: replace
      path: /spec/secretStoreRef/namespace
      value: ghost-protocol-prod

- target:
    kind: ExternalSecret
    name: openai-api-key
  patch: |-
    - op: replace
      path: /spec/secretStoreRef/namespace
      value: ghost-protocol-prod

- target:
    kind: ExternalSecret
    name: huggingface-api-key
  patch: |-
    - op: replace
      path: /spec/secretStoreRef/namespace
      value: ghost-protocol-prod

# Loki Configuration - Use production-specific S3 bucket
- target:
    kind: ConfigMap
    name: loki-write-config
  patch: |-
    - op: replace
      path: /data/loki.yaml
      value: |
        auth_enabled: false
        server:
          http_listen_port: 3100
          grpc_listen_port: 9095
          grpc_server_max_recv_msg_size: 104857600
          grpc_server_max_send_msg_size: 104857600
        common:
          path_prefix: /loki
          replication_factor: 3
          ring:
            kvstore:
              store: memberlist
            heartbeat_timeout: 10m
        memberlist:
          node_name: ${HOSTNAME}
          bind_port: 7946
          join_members:
            - loki-write-headless:7946
            - loki-read-headless:7946
            - loki-backend-headless:7946
        ingester:
          lifecycler:
            ring:
              kvstore:
                store: memberlist
              replication_factor: 3
            final_sleep: 0s
          chunk_idle_period: 5m
          chunk_retain_period: 30s
          max_chunk_age: 1h
          chunk_target_size: 1536000
          chunk_encoding: snappy
          wal:
            enabled: true
            dir: /loki/wal
            replay_memory_ceiling: 1GB
        distributor:
          ring:
            kvstore:
              store: memberlist
        schema_config:
          configs:
            - from: 2024-11-16
              store: tsdb
              object_store: s3
              schema: v13
              index:
                prefix: loki_index_
                period: 24h
        storage_config:
          aws:
            s3: s3://ghost-protocol-prod-loki-chunks
            region: us-east-1
            sse_encryption: true
            s3forcepathstyle: false
          tsdb_shipper:
            active_index_directory: /loki/tsdb-index
            cache_location: /loki/tsdb-cache
            cache_ttl: 24h
            shared_store: s3
        limits_config:
          retention_period: 720h
          enforce_metric_name: false
          reject_old_samples: true
          reject_old_samples_max_age: 168h
          ingestion_rate_mb: 10
          ingestion_burst_size_mb: 20
          per_stream_rate_limit: 5MB
          per_stream_rate_limit_burst: 15MB
          max_streams_per_user: 10000
          max_query_length: 721h
          max_entries_limit_per_query: 10000
          max_label_value_length: 2048
          max_label_name_length: 1024
          max_label_names_per_series: 30
        chunk_store_config:
          max_look_back_period: 720h
          chunk_cache_config:
            enable_fifocache: true
            fifocache:
              max_size_bytes: 500MB
              ttl: 1h
        compactor:
          working_directory: /loki/compactor
          shared_store: s3
          compaction_interval: 10m
          retention_enabled: true
          retention_delete_delay: 2h
          retention_delete_worker_count: 150
        ruler:
          storage:
            type: local
            local:
              directory: /loki/rules
          rule_path: /loki/rules-temp
          alertmanager_url: http://alertmanager:9093
          ring:
            kvstore:
              store: memberlist
          enable_api: true

# Kustomize Replacements - Dynamic value injection from .env ConfigMap
replacements:
# 1. IRSA ARN Replacements - Inject IAM role ARNs into ServiceAccounts
- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.API_GATEWAY_ROLE_ARN
  targets:
  - select:
      kind: ServiceAccount
      name: api-gateway
    fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      create: true

- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.INDEXER_ROLE_ARN
  targets:
  - select:
      kind: ServiceAccount
      name: indexer
    fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      create: true

- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.RPC_ORCHESTRATOR_ROLE_ARN
  targets:
  - select:
      kind: ServiceAccount
      name: rpc-orchestrator
    fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      create: true

- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.AI_ENGINE_ROLE_ARN
  targets:
  - select:
      kind: ServiceAccount
      name: ai-engine
    fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      create: true

- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.LOKI_ROLE_ARN
  targets:
  - select:
      kind: ServiceAccount
      name: loki
    fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      create: true

# External Secrets Operator IRSA
- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.EXTERNAL_SECRETS_OPERATOR_ROLE_ARN
  targets:
  - select:
      kind: ServiceAccount
      name: external-secrets-operator
      namespace: external-secrets
    fieldPaths:
    - metadata.annotations.[eks.amazonaws.com/role-arn]
    options:
      create: false

# Target namespace for ExternalSecrets (production)
- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.TARGET_NAMESPACE
  targets:
  - select:
      kind: SecretStore
      name: aws-secretstore
    fieldPaths:
    - metadata.namespace
    options:
      create: false

- source:
    kind: ConfigMap
    name: kustomize-values
    fieldPath: data.TARGET_NAMESPACE
  targets:
  - select:
      kind: ExternalSecret
    fieldPaths:
    - metadata.namespace
    options:
      create: false
